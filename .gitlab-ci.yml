variables:
  CI_DESIGNATED_BRANCH: prplos
  CI_SDK_PIPELINE_SOURCE: parent_pipeline

include:
  - remote: https://gitlab.com/prpl-foundation/prplOS/prplos/-/raw/prplos/.gitlab/sdk.yml

.expensive_job_rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DESIGNATED_BRANCH

generate full:
  rules:
    - !reference [.expensive_job_rules, rules]
  extends: .generate

generate:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  extends: .generate
  variables:
    CI_SDK_TARGETS: |
      ipq40xx-generic

.generate:
  extends: .generate SDK package build jobs
  variables:
    CI_SDK_TARGETS: |
      intel_mips-xrx500
      ath79-generic-19.07.7
      mvebu-cortexa9
      ipq40xx-generic
    CI_SDK_BUILD_PACKAGES: |
      acl-manager
      amx-fcgi
      amxb-inspect
      amx-cli
      amxo-cg
      amxrt
      bbf
      bbfd
      c-ares1
      cthulhu
      cthulhu-lxc
      deviceinfo-manager
      dhcpv4-manager
      dhcpv6s-manager
      ethernet-manager
      firewall4
      gmap-mibs-common
      gmap-mod-ethernet-dev
      gmap-mod-name-selector
      gmap-mod-self
      gmap-server
      ip-manager
      libamxa
      libamxb
      libamxc
      libamxd
      libamxj
      libamxm
      libamxo
      libamxp
      libamxs
      libamxt
      libarchive
      libcthulhu
      libdhcpoptions
      libfwinterface
      libfwrules
      libgmap-client
      libipat
      libnetmodel
      libocispec
      librlyeh
      libqosmod
      libradiotap
      libsahtrace
      libswla
      libswlc
      libtr69-engine
      libtrace
      libwebsockets4
      luci-mod-simple
      luci-theme-prpl
      moca-manager
      mod-amxb-ubus
      mod-ba-cli
      mod-dm-cli
      mod-dmext
      mod-dmproxy
      mod-dmstats
      mod-fw-amx
      mod-netmodel
      mod-pcm-svc
      mod-qos-tc
      mod-sahtrace
      mod-sahtrace
      mod-vlan-ioctl
      mod-vlan-uci
      multisettings
      netdev-plugin
      netmodel
      netmodel-bridge
      netmodel-clients
      netmodel-dhcpv4
      netmodel-dhcpv6
      netmodel-ethernet
      netmodel-ip
      netmodel-iprouter
      netmodel-logical
      netmodel-netdev
      netmodel-ppp
      netmodel-vlan
      obuspa
      odl-generator
      owsd
      pcm-manager
      pwhm
      rlyeh
      routing-manager
      syslog-ng
      time-manager
      timingila
      timingila-cthulhu
      timingila-rlyeh
      tr069-manager
      tr181-bridging
      tr181-device
      tr181-dhcpv4client
      tr181-dhcpv6client
      tr181-dns
      tr181-firewall
      tr181-logical
      tr181-neighbordiscovery
      tr181-ppp
      tr181-qos
      tr181-routeradvertisement
      tr181-usermanagement
      ucode
      ucwmp
      udrone
      uriparser
      wan-autosensing
      wan-manager

build:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  extends: .execute SDK package build jobs

build full:
  rules:
    - !reference [.expensive_job_rules, rules]
  stage: build
  needs:
    - generate full

  trigger:
    include:
      - artifact: sdk-package-jobs.yml
        job: generate full
    strategy: depend

.build prplmesh with SDK:
  rules:
    - !reference [.expensive_job_rules, rules]
  tags:
    - firmware-builder
  extends: .build feed with SDK
  variables:
    CI_SDK_BUILD_PACKAGES: prplmesh
    CI_SDK_BUILD_CONFIG: >
      +BUILD_LOG -AUTOREMOVE -ALL -ALL_NONSHARED -ALL_KMODS -SIGNED_PACKAGES +USE_PRPLMESH_WHM

build prplmesh with intel_mips-xrx500 SDK:
  extends: .build prplmesh with SDK
  variables:
    CI_SDK_IMAGE: registry.gitlab.com/prpl-foundation/prplos/prplos/$CI_DESIGNATED_BRANCH/sdk-intel_mips-xrx500:latest
    CI_SDK_INSTALL_FEEDS: base packages luci routing feed_intel

build prplmesh with ipq40xx-generic SDK:
  extends: .build prplmesh with SDK
  rules:
    - !reference [generate, rules]
    - !reference [.expensive_job_rules, rules]
  variables:
    CI_SDK_IMAGE: registry.gitlab.com/prpl-foundation/prplos/prplos/$CI_DESIGNATED_BRANCH/sdk-ipq40xx-generic:latest

build prplmesh with mvebu-cortexa9 SDK:
  extends: .build prplmesh with SDK
  variables:
    CI_SDK_IMAGE: registry.gitlab.com/prpl-foundation/prplos/prplos/$CI_DESIGNATED_BRANCH/sdk-mvebu-cortexa9:latest

build prplmesh with ath79-generic OpenWrt SDK:
  rules:
    - !reference [.expensive_job_rules, rules]
  extends: .build feed with OpenWrt SDK
  tags:
    - firmware-builder
  variables:
    CI_SDK_IMAGE: openwrtorg/sdk:ath79-generic-19.07.7
    CI_SDK_BUILD_PACKAGES: prplmesh
