From b7766b0b636350da931f3946a9a940877efef169 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20=C5=A0tetiar?= <ynezz@true.cz>
Date: Mon, 20 Feb 2023 23:11:59 +0100
Subject: [PATCH] tr181-ppp.sh: fix not starting service
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Service refuses to start in OpenWrt 22.03:

 root@prplOS:/# /etc/init.d/tr181-ppp start; ubus -t 5 wait_for PPP
 Command failed: Request timed out

Thats because of `name_pid="`pgrep ${name}`"` construct which is going
to match init script itself:

 root@prplOS:/# /etc/init.d/tr181-ppp start
 + ulimit -c unlimited
 + name=tr181-ppp
 + + grep ppp
 ps auxw
 root      9357  0.0  0.2   1120   524 ttyS0    S+   10:04   0:00 /bin/sh /etc/init.d/tr181-ppp start
 root      9359  0.0  0.3   1120   800 ttyS0    S+   10:04   0:00 grep ppp
 + pgrep tr181-ppp
 + name_pid=9357
 + '[' -z 9357 ]

And thus never starts.

So lets fix it by copy&pasting defacto standard init script boilerplate
from tr181-dynamicdns service.

Fixes: PCF-831
Signed-off-by: Petr Å tetiar <ynezz@true.cz>
---
 scripts/tr181-ppp.sh | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/scripts/tr181-ppp.sh b/scripts/tr181-ppp.sh
index 5fb5f7dde6e6..6f5618af314b 100755
--- a/scripts/tr181-ppp.sh
+++ b/scripts/tr181-ppp.sh
@@ -1,18 +1,18 @@
 #!/bin/sh
 [ -f /etc/environment ] && source /etc/environment
-ulimit -c ${ULIMIT_CONFIGURATION:0}
+# shellcheck disable=SC3045
+ulimit -c "${ULIMIT_CONFIGURATION:-0}"
 name="tr181-ppp"
-name_pid="`pgrep ${name}`"
 
 case $1 in
     start|boot)
-        if [ -z "${name_pid}" ]; then
-            ${name} -D
-        fi
+        ${name} -D
         ;;
     stop)
-        if [ -n "${name_pid}" ]; then
-            kill ${name_pid}
+        if [ -f /var/run/${name}.pid ]; then
+            kill "$(cat /var/run/${name}.pid)"
+        else
+            killall ${name}
         fi
         ;;
     debuginfo)
