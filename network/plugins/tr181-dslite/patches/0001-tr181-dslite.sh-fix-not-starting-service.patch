From 55427074dd880b81df5935fec3ab4ae93c10c49e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20=C5=A0tetiar?= <ynezz@true.cz>
Date: Wed, 25 Jan 2023 12:53:20 +0100
Subject: [PATCH] tr181-dslite.sh: fix not starting service
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Service refuses to start in OpenWrt 22.03:

 root@prplOS:/# /etc/init.d/tr181-dslite start; ubus -t 5 wait_for DSLite.
 Command failed: Request timed out

Thats because of `name_pid="`pgrep ${name}`"` construct which is going
to match init script itself:

 root@prplOS:/# /etc/init.d/tr181-dslite start
 + ulimit -c unlimited
 + name=tr181-dslite
 + + grep dslite
 ps auxw
 root      9357  0.0  0.2   1120   524 ttyS0    S+   10:04   0:00 /bin/sh /etc/init.d/tr181-dslite start
 root      9359  0.0  0.3   1120   800 ttyS0    S+   10:04   0:00 grep dslite
 + pgrep tr181-dslite
 + name_pid=9357
 + '[' -z 9357 ]

And thus never starts.

So lets fix it by copy&pasting defacto standard init script boilerplate
from tr181-dynamicdns service.

Fixes: PCF-832
Signed-off-by: Petr Å tetiar <ynezz@true.cz>
---
 scripts/tr181-dslite.sh | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/scripts/tr181-dslite.sh b/scripts/tr181-dslite.sh
index 80073d148450..5313f6e91e32 100755
--- a/scripts/tr181-dslite.sh
+++ b/scripts/tr181-dslite.sh
@@ -1,18 +1,18 @@
 #!/bin/sh
-[ -f /etc/environment ] && source /etc/environment
-ulimit -c ${ULIMIT_CONFIGURATION:0}
+[ -f /etc/environment ] && . /etc/environment
+# shellcheck disable=SC3045
+ulimit -c "${ULIMIT_CONFIGURATION:-0}"
 name="tr181-dslite"
-name_pid="`pgrep ${name}`"
 
 case $1 in
     start|boot)
-        if [ -z "${name_pid}" ]; then
-            ${name} -D
-        fi
+        ${name} -D
         ;;
     stop)
-        if [ -n "${name_pid}" ]; then
-            kill ${name_pid}
+        if [ -f /var/run/${name}.pid ]; then
+            kill "$(cat /var/run/${name}.pid)"
+        else
+            killall ${name}
         fi
         ;;
     debuginfo)
