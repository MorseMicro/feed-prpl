From 62afc188b1470b25357dea36f8df8f4669216755 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20=C5=A0tetiar?= <ynezz@true.cz>
Date: Wed, 25 Jan 2023 09:55:59 +0100
Subject: [PATCH 3/3] tr181-dynamicdns.sh: workaround for missing services file
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

It seems, that in the latest ddns packages there is no
/etc/ddns/services file present and services are being defined in
/usr/share/ddns/default JSON files.

Until this is fixed properly, lets workaround it by manualy generating
service file.

References: PCF-830
Signed-off-by: Petr Å tetiar <ynezz@true.cz>
---
 scripts/tr181-dynamicdns.sh | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/scripts/tr181-dynamicdns.sh b/scripts/tr181-dynamicdns.sh
index 4e7eb85bc2ab..157d6dd95005 100644
--- a/scripts/tr181-dynamicdns.sh
+++ b/scripts/tr181-dynamicdns.sh
@@ -4,8 +4,21 @@
 ulimit -c "${ULIMIT_CONFIGURATION:-0}"
 name="tr181-dynamicdns"
 
+init_services()
+{
+    [ -f /etc/ddns/services ] && return
+    mkdir -p /etc/ddns
+    for s in /usr/share/ddns/default/*; do
+        ( \
+            eval "$(jsonfilter -i "$s" -e '__dname=@.name' -e __ipv4='@.ipv4.url')" ; \
+            printf '"%s" "%s"\n' "$__dname" "$__ipv4" \
+        )
+    done >> /etc/ddns/services
+}
+
 case $1 in
     start|boot)
+        init_services
         ${name} -D
         ;;
     stop|shutdown)
